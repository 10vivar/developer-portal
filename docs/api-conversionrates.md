---
id: ConversionRates
title: ConversionRates
---
# contract ConversionRates
is [ConversionRatesInterface](api-conversionratesinterface.md), [VolumeImbalanceRecorder](api-volumeimbalancerecorder.md), [Utils](api-utils.md)\
imports [ERC20Interface](api-erc-20-interface.md), [VolumeImbalanceRecorder](api-volumeimbalancerecorder.md), [ConversionRatesInterface](api-conversionratesinterface.md), [Utils](api-utils.md)

*Source*: [ConversionRates.sol](https://github.com/KyberNetwork/smart-contracts/blob/master/contracts/ConversionRates.sol)

The ConversionRates contract's role is to allow reserve operators to make simple on-chain adjustment to the prices and is an optimized cheap (w.r.t gas consumption) interface to enter rate feeds.
___

## INDEX

<AUTOGENERATED_TABLE_OF_CONTENTS>

## REFERENCE

### Functions

### `ConversionRates`
Contract constructor. Note that constructor methods are called exactly once during contract instantiation and cannot be called again.
___
function __ConversionRates__(address \_admin) public
| Parameter        | Type                     | Description                      |
| -----------------|:------------------------:|:--------------------------------:|
| `_admin`         | address                  | admin's wallet address           |
___
<br />

### `addToken`
Adding an ERC20 token which the reserve will support. Only admin can invoke.
___
function __addToken__(ERC20 token) public
| Parameter        | Type                     | Description                      |
| -----------------|:------------------------:|:--------------------------------:|
| `token`         | ERC20                  | ERC20 token contract address           |
Modifiers: [onlyAdmin](api-permissiongroups.md#onlyadmin)
___
Web3 Example:
```js
ConversionRates.methods.addToken(
  "0xdd974D5C2e2928deA5F71b9825b8b646686BD200", // token: KNC
).send(
  {
    from: fromAddress,
  },
  (err, res) => {
      console.log(`Err: ${err}`);
      console.log(`Res: ${res}`);
  }
)
```
<br />

### `setCompactData`
Setting minor adjustments in basis points (bps) to tokens' buy and sell rates. `1bps = 0.01%` Only operator can invoke.
___
function __setCompactData__(bytes14[] buy, bytes14[] sell, uint blockNumber, uint[] indices) public
| Parameter        | Type                     | Description                      |
| -----------------|:------------------------:|:--------------------------------:|
| `buy`         | bytes14[]             | basis points to adjust tokens' buy rates           |
| `sell`         | bytes14[]                  | basis points to adjust tokens' sell rates           |
| `blockNumber`         | uint             | ETH block number for which the adjustment rates are valid from           |
| `indices`         | uint[]             | array of indexes to apply the buy / sell rate adjustments on           |
Modifiers: [onlyOperator](api-permissiongroups.md#onlyoperator)
___
Web3 Example:
```js
ConversionRates.methods.setCompactData(
	[3752], // bytes14[] buy
	[698e], // bytes14[] sell
	5878441, //uint blockNumber
	[0] //uint[] indices
).send(
  {
    from: fromAddress,
  },
  (err, res) => {
      console.log(`Err: ${err}`);
      console.log(`Res: ${res}`);
  }
)
```
<br />

### `setBaseRates`
Set tokens' base buy and sell rates, and optional adjustments to these rates. Only operator can invoke.
___
function __setBaseRates__(ERC20[] tokens, uint[] baseBuy, uint[] baseSell, bytes14[] buy, bytes14[] sell, uint blockNumber, uint[] indices) public
| Parameter        | Type                     | Description                      |
| -----------------|:------------------------:|:--------------------------------:|
| `tokens`         | ERC20[]             | array of token contract addresses to set the base rates for           |
| `baseBuy`         | uint[]             | array of token buy rates in wei amount           |
| `baseSell`         | uint[]             | array of token sell rates in wei amount           |
| `buy`         | bytes14[]             | Compact data representation of basis points (bps) to adjust tokens' buy rates. `1bps = 0.01%`         |
| `sell`         | bytes14[]             | Compact data representation of basis points (bps) to adjust tokens' sell rates. `1bps = 0.01%`          |
| `blockNumber`         | uint             | ETH block number for which the adjustments are valid from           |
| `indices`         | uint[]             | array of indexes to apply bps adjustments on           |
Modifiers: [onlyOperator](api-permissiongroups.md#onlyoperator)
___
Web3 Example:
```js
ConversionRates.methods.setBaseRates(
	["0xdd974D5C2e2928deA5F71b9825b8b646686BD200","0xd26114cd6EE289AccF82350c8d8487fedB8A0C07"] //ERC20[] tokens: KNC, OMG
	[500000000000000000000,600000000000000000000] //uint[] baseBuy
	[1820000000000000,1920000000000000] //uint[] baseSell
  [3752], // bytes14[] buy
	[698e], // bytes14[] sell
	5878441, //uint blockNumber
	[0] //uint[] indices
).send(
  {
    from: fromAddress,
  },
  (err, res) => {
      console.log(`Err: ${err}`);
      console.log(`Res: ${res}`);
  }
)
```
<br />

### `setQtyStepFunction`
Set adjustments for tokens' buy and sell rates depending on the size of a buy / sell order. Only operator can invoke.
___
function __setQtyStepFunction__(ERC20[] tokens, int[] xBuy, int[] yBuy, int[] xSell, int[] ySell) public
| Parameter        | Type                     | Description                      |
| -----------------|:------------------------:|:--------------------------------:|
| `tokens`         | ERC20[]             | array of token contract addresses to set the base rates for           |
| `xBuy`         | int[]             | array of buy steps in wei amount           |
| `yBuy`         | int[]             | impact on buy rate in basis points (bps). `1 bps = 0.01%` Eg. `-30 = -0.3%`           |
| `xSell`         | int[]            | array of sell steps in wei amount           |
| `ySell`         | int[]             | impact on sell rate in basis points (bps). `1 bps = 0.01%` Eg. `-30 = -0.3%`           |
Modifiers: [onlyOperator](api-permissiongroups.md#onlyoperator)
___
Web3 Example:
```js
ConversionRates.methods.setQtyStepFunction(
	["0xdd974D5C2e2928deA5F71b9825b8b646686BD200"] //ERC20[] tokens: KNC
	[100000000000000000000,200000000000000000000,300000000000000000000,5000000000000000000000] //uint[] xBuy
	[0,-30,-60,-80] //uint[] yBuy
	[100000000000000000000,200000000000000000000,300000000000000000000,5000000000000000000000] //uint[] xSell
	[0,-30,-60,-80] //uint[] ySell
).send(
  {
    from: fromAddress,
  },
  (err, res) => {
      console.log(`Err: ${err}`);
      console.log(`Res: ${res}`);
  }
)
```
<br />

### `setImbalanceStepFunction`
Set adjustments for tokens' buy and sell rates depending on the net traded amounts. Only operator can invoke.
___
function __setImbalanceStepFunction__(ERC20[] tokens, int[] xBuy, int[] yBuy, int[] xSell, int[] ySell) public
| Parameter        | Type                     | Description                      |
| -----------------|:------------------------:|:--------------------------------:|
| `tokens`         | ERC20[]             | array of token contract addresses to set the base rates for           |
| `xBuy`         | int[]             | array of buy steps in wei amount           |
| `yBuy`         | int[]             | impact on buy rate in basis points (bps). `1 bps = 0.01%` Eg. `-30 = -0.3%`           |
| `xSell`         | int[]             | array of sell steps in wei amount           |
| `ySell`         | int[]             | impact on sell rate in basis points (bps). `1 bps = 0.01%` Eg. `-30 = -0.3%`           |
Modifiers: [onlyOperator](api-permissiongroups.md#onlyoperator)
___
Web3 Example:
```js
ConversionRates.methods.setImbalanceStepFunction(
	["0xdd974D5C2e2928deA5F71b9825b8b646686BD200"] //ERC20[] tokens: KNC
	[100000000000000000000,200000000000000000000,300000000000000000000,5000000000000000000000] //uint[] xBuy
	[0,-30,-60,-80] //uint[] yBuy
	[100000000000000000000,200000000000000000000,300000000000000000000,5000000000000000000000] //uint[] xSell
	[0,-30,-60,-80] //uint[] ySell
).send(
  {
    from: fromAddress,
  },
  (err, res) => {
      console.log(`Err: ${err}`);
      console.log(`Res: ${res}`);
  }
)
```
<br />

### `setValidRateDurationInBlocks`
Set the duration (in blocks) for which the rates will be valid for. Only admin can invoke.
___
function __setValidRateDurationInBlocks__(uint duration) public
| Parameter        | Type                     | Description                      |
| -----------------|:------------------------:|:--------------------------------:|
| `duration`         | uint                  | Number of blocks for which the rates will be valid           |
Modifiers: [onlyAdmin](api-permissiongroups.md#onlyadmin)
___
Web3 Example:
```js
ConversionRates.methods.setValidRateDurationInBlocks(
	24 //uint duration
).send(
  {
    from: fromAddress,
  },
  (err, res) => {
      console.log(`Err: ${err}`);
      console.log(`Res: ${res}`);
  }
)
```
<br />

### `enableTokenTrade`
Enables the reserve token to be traded. Only admin can invoke.
___
function __enableTokenTrade__(ERC20 token) public
| Parameter        | Type                     | Description                      |
| -----------------|:------------------------:|:--------------------------------:|
| `token`         | ERC20                  | Token contract address to be enabled          |
Modifiers: [onlyAdmin](api-permissiongroups.md#onlyadmin)
___
Web3 Example:
```js
ConversionRates.methods.enableTokenTrade(
	"0xdd974D5C2e2928deA5F71b9825b8b646686BD200" //ERC20 token: KNC
).send(
  {
    from: fromAddress,
  },
  (err, res) => {
      console.log(`Err: ${err}`);
      console.log(`Res: ${res}`);
  }
)
```
<br />

### `disableTokenTrade`
Disables the reserve token from trades. Only alerters can invoke.
___
function __disableTokenTrade__(ERC20 token) public
| Parameter        | Type                     | Description                      |
| -----------------|:------------------------:|:--------------------------------:|
| `token`         | ERC20                  | Token contract address to be disabled          |
Modifiers: [onlyAlerter](api-permissiongroups.md#onlyalerter)
___
Web3 Example:
```js
ConversionRates.methods.disableTokenTrade(
	"0xdd974D5C2e2928deA5F71b9825b8b646686BD200" //ERC20 token: KNC
).send(
  {
    from: fromAddress,
  },
  (err, res) => {
      console.log(`Err: ${err}`);
      console.log(`Res: ${res}`);
  }
)
```
<br />

### `setReserveAddress`
Set / change the reserve contract address. Only admin can invoke.
___
function __setReserveAddress__(address reserve) public
| Parameter        | Type                     | Description                      |
| -----------------|:------------------------:|:--------------------------------:|
| `reserve`         | address                  | reserve contract address          |
Modifiers: [onlyAdmin](api-permissiongroups.md#onlyadmin)
___
Web3 Example:
```js
ConversionRates.methods.setReserveAddress(
	"0x63825c174ab367968EC60f061753D3bbD36A0D8F" //Eg. KyberReserve contract address
).send(
  {
    from: fromAddress,
  },
  (err, res) => {
      console.log(`Err: ${err}`);
      console.log(`Res: ${res}`);
  }
)
```
<br />

### `recordImbalance`
To record the imbalance of a reserve token after a trade was executed. Only invoked by reserve contract.
___
function __recordImbalance__(ERC20 token, int buyAmount, uint rateUpdateBlock, uint currentBlock) public
| Parameter        | Type                     | Description                      |
| -----------------|:------------------------:|:--------------------------------:|
| `token`         | ERC20                  | Token contract address      |
| `buyAmount`         | int                  | Token wei amount bought or sold          |
| `rateUpdateBlock` | uint      | block number for which the rates are valid from, ie. `blockNumber` of `setCompactData` function          |
| `currentBlock` | uint      | block number for which trade was executed          |
___
<br />

### `getRate`
To obtain the (adjusted) buy or sell rate of a token.
___
function __getRate__(ERC20 token, uint currentBlockNumber, bool buy, uint qty) public view returns (uint)
| Parameter        | Type                     | Description                      |
| -----------------|:------------------------:|:--------------------------------:|
| `token`         | ERC20                  | Token contract address      |
| `currentBlockNumber`         | uint                  | To see if rates' adjustments are applicable on this ETH block number    |
| `buy` | bool      | `true` = buy rate, `false` = sell rate        |
| `qty` | uint      | Token quantity          |
**Returns:**\
(Adjusted) buy or sell rate of a token in wei amount
___
Web3 Example:
```js
let result = await ConversionRates.methods.getRate(
	"0xdd974D5C2e2928deA5F71b9825b8b646686BD200", //ERC20 token: KNC
	5878441, //uint currentBlockNumber
	true, //bool buy
	100000000000000000000 //uint qty
).call()

let buyRate = result[0]
```
<br />

### `getBasicRate`
To obtain the base buy or sell rate of a token.
___
function __getBasicRate__(ERC20 token, bool buy) public view returns (uint)
| Parameter        | Type                     | Description                      |
| -----------------|:------------------------:|:--------------------------------:|
| `token`         | ERC20                  | Token contract address      |
| `buy` | bool      |  `true` = buy rate, `false` = sell rate         |
**Returns:**\
Base buy or sell rate of a token in wei amount
___
Web3 Example:
```js
let result = await ConversionRates.methods.getBasicRate(
	"0xdd974D5C2e2928deA5F71b9825b8b646686BD200", //ERC20 token: KNC
	false, //bool buy
	100000000000000000000 //uint qty
).call()

let basicSellRate = result[0]
```
<br />


### `getCompactData`
To obtain the basis points (bps) adjustments of a token.
___
function __getCompactData__(ERC20 token) public view returns (uint, uint, byte, byte)
| Parameter | Type  | Description                  |
| ----------|:-----:|:----------------------------:|
| `token`   | ERC20 | ERC20 token contract address |
**Returns:**
1. Array index of token
2. fieldOffset of token
3. bps adjustment to base buy rate of token
4. bps adjustment to base sell rate of token
___
Web3 Example:
```js
let result = await ConversionRates.methods.getCompactData(
	"0xdd974D5C2e2928deA5F71b9825b8b646686BD200", //ERC20 token: KNC
).call()

let arrayIndex = result[0]
let fieldOffset = result[1]
let buyRateBPS = result[2]
let sellRateBPS = result[3]
```
<br />

### `getTokenBasicData`
To obtain the basic information of a token
___
function __getTokenBasicData__(ERC20 token) public view returns (bool, bool)
| Parameter        | Type                     | Description                      |
| -----------------|:------------------------:|:--------------------------------:|
| `token`         | ERC20                  | Token contract address      |
**Returns:**
1. Whether a token is listed
2. Whether a token is enabled
___
Web3 Example:
```js
let result = await ConversionRates.methods.getTokenBasicData(
	"0xdd974D5C2e2928deA5F71b9825b8b646686BD200", //ERC20 token: KNC
).call()

let tokenListed = result[0]
let tokenEnabled = result[1]
```
<br />


### `getStepFunctionData`
To obtain data of the step function of a token.
___
function __getStepFunctionData__(ERC20 token, uint command, uint param) public view returns (int)
| Parameter        | Type                     | Description                      |
| -----------------|:------------------------:|:--------------------------------:|
| `token`         | ERC20                  | Token contract address      |
|`command`   | uint                   | Number within `0` to `15` inclusive |
|`param`   | uint                   | Index of step function data to obtain |

**Returns:**\
**Dependent on `command`**

**To determine what inputs to use, it is best to refer the solidity code below.**
```
function getStepFunctionData(ERC20 token, uint command, uint param) public view returns(int) {
        if (command == 0) return int(tokenData[token].buyRateQtyStepFunction.x.length);
        if (command == 1) return tokenData[token].buyRateQtyStepFunction.x[param];
        if (command == 2) return int(tokenData[token].buyRateQtyStepFunction.y.length);
        if (command == 3) return tokenData[token].buyRateQtyStepFunction.y[param];

        if (command == 4) return int(tokenData[token].sellRateQtyStepFunction.x.length);
        if (command == 5) return tokenData[token].sellRateQtyStepFunction.x[param];
        if (command == 6) return int(tokenData[token].sellRateQtyStepFunction.y.length);
        if (command == 7) return tokenData[token].sellRateQtyStepFunction.y[param];

        if (command == 8) return int(tokenData[token].buyRateImbalanceStepFunction.x.length);
        if (command == 9) return tokenData[token].buyRateImbalanceStepFunction.x[param];
        if (command == 10) return int(tokenData[token].buyRateImbalanceStepFunction.y.length);
        if (command == 11) return tokenData[token].buyRateImbalanceStepFunction.y[param];

        if (command == 12) return int(tokenData[token].sellRateImbalanceStepFunction.x.length);
        if (command == 13) return tokenData[token].sellRateImbalanceStepFunction.x[param];
        if (command == 14) return int(tokenData[token].sellRateImbalanceStepFunction.y.length);
        if (command == 15) return tokenData[token].sellRateImbalanceStepFunction.y[param];

        revert();
    }
```
___
Web3 Example:
```js
let result = await ConversionRates.methods.getStepFunctionData(
	"0xdd974D5C2e2928deA5F71b9825b8b646686BD200", //ERC20 token: KNC
	0, //uint command
	0 //uint param
).call()

let buyRateQtyStepFunctionLength = result[0]
```
<br />

### `getRateUpdateBlock`
To obtain the block number for which the basis points (bps) adjustments are valid from
___
function __getRateUpdateBlock__(ERC20 token) public view returns (uint)
| Parameter        | Type                     | Description                      |
| -----------------|:------------------------:|:--------------------------------:|
| `token`         | ERC20                  | Token contract address      |
**Returns:**\
**Block number for which the basis points (bps) adjustments are valid from**
___
Web3 Example:
```js
let result = await ConversionRates.methods.getRateUpdateBlock(
	"0xdd974D5C2e2928deA5F71b9825b8b646686BD200", //ERC20 token: KNC
).call()

let rateUpdateBlock = result[0]
```
<br />


### `getListedTokens`
To obtain a list of supported reserve tokens
___
function __getListedTokens__() public view returns (ERC20[])
___
Web3 Example:
```js
let result = await ConversionRates.methods.getListedTokens().call()
```
<br />


### `getTokenQty`
Compute the token quantity in wei amount based on the conversion rate
___
function __getTokenQty__(ERC20 token, uint ethQty, uint rate) internal view returns (uint)
| Parameter        | Type                     | Description                      |
| -----------------|:------------------------:|:--------------------------------:|
| `token`         | ERC20                  | Token contract address      |
| `ethQty`         | uint                | Ether quantity     |
| `rate`         | uint                  | Conversion rate   |
<br />


### `getLast4Bytes`
Obtain the last 4 bytes from a 32bytes string
___
function __getLast4Bytes__(bytes32 b) internal pure returns (uint)
| Parameter        | Type                     | Description                      |
| -----------------|:------------------------:|:--------------------------------:|
| `b`         | bytes32                  |       |
<br />


### `getRateByteFromCompactData`
Obtain the token conversion rate from the compact data representation
___
function __getRateByteFromCompactData__(bytes32 data, ERC20 token, bool buy) internal pure returns (int8)
| Parameter        | Type                     | Description                      |
| -----------------|:------------------------:|:--------------------------------:|
| `data`         | bytes32                  |   Compact data representation of the conversion rates    |
| `token`         | ERC20                  | Token contract address      |
| `buy` | bool      |  `true` = buy rate, `false` = sell rate         |

**Returns:**\
Rate byte
<br />


### `executeStepFunction`
Obtain the basis points (bps) depending on the reserve token imbalance or buy / sell order quantity
___
function __executeStepFunction__(StepFunction f, int x) internal pure returns (int)
| Parameter        | Type                     | Description                      |
| -----------------|:------------------------:|:--------------------------------:|
| `f`         | StepFunction                  |   Buy / Sell quantity or token imbalance step function    |
| `x`         | int                  | Token quantity or imbalance amount       |

**Returns:**\
Basis point
<br />


### `addBps`
Add basis points (bps) to the rate
___
function __addBps__(uint rate, int bps) internal pure returns (uint)
| Parameter        | Type                     | Description                      |
| -----------------|:------------------------:|:--------------------------------:|
| `rate`         | uint                  |   Token conversion rate    |
| `bps`         | int                  | Amount calculated from the step function        |

**Returns:**\
Adjusted rate
<br />


### `abs`
Obtain the absolute value or modulus of a number
___
function __abs__(int x) internal pure returns (uint)
| Parameter        | Type                     | Description                      |
| -----------------|:------------------------:|:--------------------------------:|
| `x`         | int                  |   An integer    |

**Returns:**\
Absolute value of a number
<br />
